<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Word Game Generator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #fff;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.2rem;
      color: #00d9ff;
    }

    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 40px;
    }

    .api-section {
      background: #0f0f23;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid #333;
    }

    .api-section label {
      display: block;
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 8px;
    }

    .api-input {
      width: 100%;
      padding: 12px 15px;
      font-size: 1rem;
      border: 2px solid #333;
      border-radius: 8px;
      background: #1a1a2e;
      color: #fff;
      font-family: monospace;
    }

    .api-input:focus {
      outline: none;
      border-color: #00d9ff;
    }

    .api-note {
      font-size: 0.75rem;
      color: #666;
      margin-top: 8px;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-size: 0.85rem;
      color: #aaa;
    }

    .date-input, .length-select, .category-select {
      padding: 12px 20px;
      font-size: 1rem;
      border: 2px solid #00d9ff;
      border-radius: 8px;
      background: #0f0f23;
      color: #fff;
      cursor: pointer;
    }

    .date-input:focus, .length-select:focus, .category-select:focus {
      outline: none;
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
    }

    .btn {
      padding: 12px 30px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #00d9ff 0%, #00a8cc 100%);
      color: #0f0f23;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
      color: #fff;
    }

    .btn-success {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: #fff;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    .btn.loading .spinner {
      display: block;
    }

    .btn.loading .btn-text {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: linear-gradient(135deg, #3d1a1a 0%, #4a2020 100%);
      border: 1px solid #ff6b6b;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #ff6b6b;
      display: none;
    }

    .error-message.visible {
      display: block;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .progress-section {
      display: none;
      margin-bottom: 30px;
    }

    .progress-section.visible {
      display: block;
    }

    .progress-bar-container {
      background: #0f0f23;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #333;
    }

    .progress-bar-bg {
      background: #1a1a2e;
      border-radius: 8px;
      height: 24px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-bar-fill {
      background: linear-gradient(135deg, #00d9ff 0%, #00a8cc 100%);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 8px;
    }

    .progress-text {
      text-align: center;
      color: #aaa;
      font-size: 0.9rem;
    }

    .progress-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 15px;
      font-size: 0.85rem;
    }

    .progress-stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-success {
      color: #4caf50;
    }

    .stat-failed {
      color: #ff6b6b;
    }

    .stat-invalid {
      color: #ffa726;
    }

    .result-section {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .result-section.visible {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .selection-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .selection-controls .btn {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .selection-count {
      color: #00d9ff;
      font-weight: 600;
    }

    .sets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .set-card {
      background: #0f0f23;
      border-radius: 12px;
      border: 2px solid #333;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .set-card.selected {
      border-color: #4caf50;
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
    }

    .set-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: #1a1a2e;
      border-bottom: 1px solid #333;
    }

    .set-checkbox {
      width: 22px;
      height: 22px;
      cursor: pointer;
      accent-color: #4caf50;
    }

    .set-number {
      background: #00d9ff;
      color: #0f0f23;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
    }

    .set-theme {
      font-size: 1.1rem;
      font-weight: 700;
      color: #ff6b6b;
      letter-spacing: 2px;
    }

    .set-category {
      margin-left: auto;
      font-size: 0.75rem;
      color: #888;
    }

    .set-card-body {
      padding: 15px;
    }

    .set-words {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .set-word {
      background: linear-gradient(135deg, #1a1a3e 0%, #252550 100%);
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      letter-spacing: 1px;
      font-size: 0.85rem;
    }

    .set-word.theme {
      background: linear-gradient(135deg, #3d1a1a 0%, #4a2020 100%);
      border: 1px solid #ff6b6b;
    }

    .set-hint {
      background: linear-gradient(135deg, #1a3d1a 0%, #204a20 100%);
      padding: 10px 12px;
      border-radius: 6px;
      border-left: 3px solid #4caf50;
      color: #a5d6a7;
      font-size: 0.85rem;
    }

    .output-section {
      margin-top: 30px;
      display: none;
    }

    .output-section.visible {
      display: block;
    }

    .output-section h2 {
      font-size: 1.4rem;
      color: #00d9ff;
      margin-bottom: 20px;
      text-align: center;
    }

    .output-box {
      background: #0a0a15;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    .output-box h3 {
      font-size: 1rem;
      color: #00d9ff;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .output-box h3 .count {
      background: #00d9ff;
      color: #0f0f23;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    .output-box code {
      display: block;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #ffd93d;
      white-space: pre-wrap;
      line-height: 1.8;
      max-height: 400px;
      overflow-y: auto;
    }

    .copy-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 8px 16px;
      font-size: 0.8rem;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .copy-btn:hover {
      background: #00d9ff;
      color: #0f0f23;
    }

    .copy-btn.copied {
      background: #4caf50;
    }

    .generate-output-section {
      text-align: center;
      padding: 20px;
      background: #0f0f23;
      border-radius: 12px;
      border: 1px solid #333;
      margin-bottom: 30px;
    }

    .generate-output-section p {
      margin-bottom: 15px;
      color: #aaa;
    }

    @media (max-width: 600px) {
      .sets-grid {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
      }

      .control-group {
        width: 100%;
      }

      .date-input, .length-select, .category-select, .btn {
        width: 100%;
      }

      .set-card-header {
        flex-wrap: wrap;
      }

      .set-category {
        margin-left: 0;
        width: 100%;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ AI Word Game Generator</h1>
    <p class="subtitle">Generate 100 unique themed word sets using AI</p>

    <div class="api-section">
      <label for="apiKey">OpenAI API Key</label>
      <input 
        type="password" 
        class="api-input" 
        id="apiKey" 
        placeholder="sk-..."
      >
      <p class="api-note">Your API key is stored locally and never sent anywhere except OpenAI.</p>
    </div>

    <div class="controls">
      <div class="control-group">
        <label for="startDateInput">Starting Date</label>
        <input type="date" class="date-input" id="startDateInput">
      </div>
      
      <div class="control-group">
        <label for="lengthSelect">Word Length</label>
        <select class="length-select" id="lengthSelect">
          <option value="5">5 letters</option>
          <option value="6" selected>6 letters</option>
          <option value="7">7 letters</option>
          <option value="8">8 letters</option>
        </select>
      </div>

      <div class="control-group">
        <label for="categorySelect">Category</label>
        <select class="category-select" id="categorySelect">
          <option value="random">üé≤ Random (Mixed)</option>
          <option value="food">üçï Food & Cooking</option>
          <option value="sports">‚öΩ Sports</option>
          <option value="music">üéµ Music</option>
          <option value="travel">‚úàÔ∏è Travel</option>
          <option value="animals">ü¶Å Animals</option>
          <option value="science">üî¨ Science</option>
          <option value="movies">üé¨ Movies & TV</option>
          <option value="technology">üíª Technology</option>
          <option value="nature">üå≤ Nature</option>
          <option value="household">üè† Household</option>
          <option value="clothing">üëï Clothing</option>
          <option value="vehicles">üöó Vehicles</option>
          <option value="weather">üå§Ô∏è Weather</option>
          <option value="jobs">üíº Jobs & Careers</option>
          <option value="hobbies">üé® Hobbies</option>
          <option value="body">ü´Ä Human Body</option>
          <option value="buildings">üèõÔ∏è Buildings</option>
          <option value="tools">üîß Tools</option>
          <option value="games">üéÆ Games</option>
        </select>
      </div>

      <div class="control-group">
        <label>&nbsp;</label>
        <button class="btn btn-primary" id="generateBtn">
          <span class="btn-text">Generate 100 Sets</span>
          <div class="spinner"></div>
        </button>
      </div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <div class="progress-section" id="progressSection">
      <div class="progress-bar-container">
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="progressBar"></div>
        </div>
        <p class="progress-text" id="progressText">Generating set 1 of 100...</p>
        <div class="progress-stats">
          <span class="progress-stat stat-success">‚úì Valid: <span id="validCount">0</span></span>
          <span class="progress-stat stat-invalid">‚ö† Invalid words: <span id="invalidWordCount">0</span></span>
          <span class="progress-stat stat-failed">‚úó Failed: <span id="failedCount">0</span></span>
        </div>
      </div>
    </div>

    <div class="result-section" id="resultSection">
      <div class="selection-controls">
        <button class="btn btn-secondary" id="selectAllBtn">Select All</button>
        <button class="btn btn-secondary" id="deselectAllBtn">Deselect All</button>
        <span class="selection-count"><span id="selectedCount">0</span> of <span id="totalCount">0</span> selected</span>
      </div>

      <div class="sets-grid" id="setsGrid"></div>

      <div class="generate-output-section">
        <p>Select the sets you want to use, then generate the output. Dates will be assigned sequentially from your starting date.</p>
        <button class="btn btn-success" id="generateOutputBtn">
          <span class="btn-text">üìã Generate Output for Selected Sets</span>
        </button>
      </div>

      <div class="output-section" id="outputSection">
        <h2>üìã Copy-Ready Output (Grouped by Type)</h2>

        <div class="output-box">
          <h3>Words Arrays <span class="count" id="wordsCount">0</span></h3>
          <button class="copy-btn" data-target="wordsOutput">Copy</button>
          <code id="wordsOutput"></code>
        </div>

        <div class="output-box">
          <h3>Themes <span class="count" id="themesCount">0</span></h3>
          <button class="copy-btn" data-target="themesOutput">Copy</button>
          <code id="themesOutput"></code>
        </div>

        <div class="output-box">
          <h3>Hints <span class="count" id="hintsCount">0</span></h3>
          <button class="copy-btn" data-target="hintsOutput">Copy</button>
          <code id="hintsOutput"></code>
        </div>
      </div>
    </div>
  </div>

  <script>
    const categories = {
      random: null,
      food: "Food, cooking, kitchen items, ingredients, or meals",
      sports: "Sports, athletics, games, or physical activities",
      music: "Music, instruments, musicians, or musical terms",
      travel: "Travel, tourism, transportation, or destinations",
      animals: "Animals, wildlife, pets, or creatures",
      science: "Science, chemistry, physics, biology, or experiments",
      movies: "Movies, television, cinema, actors, or film genres",
      technology: "Technology, computers, gadgets, or electronics",
      nature: "Nature, outdoors, landscapes, or natural phenomena",
      household: "Household items, furniture, or home appliances",
      clothing: "Clothing, fashion, accessories, or fabrics",
      vehicles: "Vehicles, cars, transportation, or automotive",
      weather: "Weather, climate, seasons, or atmospheric conditions",
      jobs: "Jobs, careers, professions, or workplace",
      hobbies: "Hobbies, crafts, leisure activities, or pastimes",
      body: "Human body, anatomy, health, or medicine",
      buildings: "Buildings, architecture, structures, or construction",
      tools: "Tools, equipment, hardware, or workshop items",
      games: "Games, toys, puzzles, or entertainment"
    };

    const categoryEmojis = {
      random: "üé≤",
      food: "üçï",
      sports: "‚öΩ",
      music: "üéµ",
      travel: "‚úàÔ∏è",
      animals: "ü¶Å",
      science: "üî¨",
      movies: "üé¨",
      technology: "üíª",
      nature: "üå≤",
      household: "üè†",
      clothing: "üëï",
      vehicles: "üöó",
      weather: "üå§Ô∏è",
      jobs: "üíº",
      hobbies: "üé®",
      body: "ü´Ä",
      buildings: "üèõÔ∏è",
      tools: "üîß",
      games: "üéÆ"
    };

    const startDateInput = document.getElementById('startDateInput');
    const apiKeyInput = document.getElementById('apiKey');
    const generateBtn = document.getElementById('generateBtn');
    const errorMessage = document.getElementById('errorMessage');
    const resultSection = document.getElementById('resultSection');
    const lengthSelect = document.getElementById('lengthSelect');
    const categorySelect = document.getElementById('categorySelect');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const setsGrid = document.getElementById('setsGrid');
    const outputSection = document.getElementById('outputSection');

    let generatedSets = [];
    let usedThemes = new Set();
    let validWordCache = new Map();

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    startDateInput.value = today;

    // Load saved API key
    const savedKey = localStorage.getItem('openai_api_key');
    if (savedKey) {
      apiKeyInput.value = savedKey;
    }

    // Save API key on change
    apiKeyInput.addEventListener('change', () => {
      localStorage.setItem('openai_api_key', apiKeyInput.value);
    });

    generateBtn.addEventListener('click', generateAllSets);
    document.getElementById('selectAllBtn').addEventListener('click', selectAll);
    document.getElementById('deselectAllBtn').addEventListener('click', deselectAll);
    document.getElementById('generateOutputBtn').addEventListener('click', generateOutput);

    // Dictionary API validation
    async function isValidWord(word) {
      const cleanWord = word.toLowerCase().trim();
      
      // Check cache first
      if (validWordCache.has(cleanWord)) {
        return validWordCache.get(cleanWord);
      }

      try {
        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${cleanWord}`);
        const isValid = response.ok;
        validWordCache.set(cleanWord, isValid);
        return isValid;
      } catch (error) {
        // If API fails, assume valid to not block generation
        console.warn(`Dictionary API check failed for "${cleanWord}":`, error);
        return true;
      }
    }

    async function validateAllWords(words) {
      const results = await Promise.all(words.map(async (word) => {
        const isValid = await isValidWord(word);
        return { word, isValid };
      }));
      
      const invalidWords = results.filter(r => !r.isValid).map(r => r.word);
      return {
        allValid: invalidWords.length === 0,
        invalidWords
      };
    }

    async function generateAllSets() {
      const apiKey = apiKeyInput.value.trim();
      const startDate = startDateInput.value;
      const wordLength = parseInt(lengthSelect.value);
      const selectedCategory = categorySelect.value;

      if (!apiKey) {
        showError('Please enter your OpenAI API key');
        return;
      }

      if (!startDate) {
        showError('Please select a starting date');
        return;
      }

      hideError();
      setLoading(true);
      resultSection.classList.remove('visible');
      outputSection.classList.remove('visible');
      progressSection.classList.add('visible');
      
      generatedSets = [];
      usedThemes.clear();
      
      const totalSets = 100;
      let successCount = 0;
      let failedCount = 0;
      let invalidWordCount = 0;

      // Update stats display
      document.getElementById('validCount').textContent = '0';
      document.getElementById('invalidWordCount').textContent = '0';
      document.getElementById('failedCount').textContent = '0';

      // Generate category rotation for variety
      const categoryKeys = Object.keys(categories).filter(k => k !== 'random');
      let categoryIndex = 0;

      for (let i = 0; i < totalSets; i++) {
        updateProgress(i, totalSets);
        
        // Pick category for this set
        let category = selectedCategory;
        if (category === 'random') {
          // Rotate through categories to ensure variety
          category = categoryKeys[categoryIndex % categoryKeys.length];
          categoryIndex++;
        }

        let attempts = 0;
        const maxAttempts = 5;
        let success = false;

        while (attempts < maxAttempts && !success) {
          attempts++;
          try {
            const result = await fetchWordsFromAI(apiKey, wordLength, category, Array.from(usedThemes));
            
            if (result.error) {
              throw new Error(result.error);
            }

            const validation = validateWords(result, wordLength);
            
            if (!validation.valid) {
              console.warn(`Set ${i + 1}, attempt ${attempts}: ${validation.reason}`);
              continue;
            }

            // Check if theme is duplicate
            const themeClean = result.theme.toUpperCase().replace(/[^A-Z]/g, '');
            if (usedThemes.has(themeClean)) {
              console.warn(`Set ${i + 1}, attempt ${attempts}: Duplicate theme "${themeClean}"`);
              continue;
            }

            // Validate all words against dictionary
            const allWords = [result.theme, ...result.words];
            const dictValidation = await validateAllWords(allWords);
            
            if (!dictValidation.allValid) {
              console.warn(`Set ${i + 1}, attempt ${attempts}: Invalid words found: ${dictValidation.invalidWords.join(', ')}`);
              invalidWordCount++;
              document.getElementById('invalidWordCount').textContent = invalidWordCount;
              continue;
            }

            // Success - add to sets
            usedThemes.add(themeClean);
            generatedSets.push({
              ...result,
              category,
              wordLength,
              selected: false
            });
            
            successCount++;
            document.getElementById('validCount').textContent = successCount;
            success = true;
          } catch (error) {
            console.error(`Set ${i + 1}, attempt ${attempts} failed:`, error);
          }
        }

        if (!success) {
          failedCount++;
          document.getElementById('failedCount').textContent = failedCount;
          console.warn(`Failed to generate set ${i + 1} after ${maxAttempts} attempts`);
        }
      }

      progressSection.classList.remove('visible');
      setLoading(false);

      if (generatedSets.length > 0) {
        displaySets();
        resultSection.classList.add('visible');
      } else {
        showError('Failed to generate any valid sets. Please try again.');
      }
    }

    function updateProgress(current, total) {
      const percent = ((current + 1) / total) * 100;
      progressBar.style.width = `${percent}%`;
      progressText.textContent = `Generating set ${current + 1} of ${total}...`;
    }

    async function fetchWordsFromAI(apiKey, wordLength, category, usedThemesList) {
      const categoryDescription = categories[category];
      
      // Create a list of recently used themes to avoid
      const recentThemes = usedThemesList.slice(-50).join(', ');
      const avoidThemesInstruction = recentThemes 
        ? `\n\nIMPORTANT: Do NOT use any of these themes (already used): ${recentThemes}` 
        : '';

      // Random seed word suggestions for variety
      const seedConcepts = [
        'everyday objects', 'actions/verbs', 'places', 'materials', 'emotions',
        'time-related', 'shapes', 'colors', 'textures', 'sounds',
        'movements', 'containers', 'tools', 'natural things', 'man-made items',
        'abstract concepts', 'body parts', 'weather phenomena', 'food items', 'animals',
        'plants', 'furniture', 'clothing', 'vehicles', 'buildings',
        'professions', 'sports equipment', 'musical terms', 'art supplies', 'kitchen items'
      ];
      const randomSeed = seedConcepts[Math.floor(Math.random() * seedConcepts.length)];
      
      const prompt = `Generate a UNIQUE and CREATIVE word puzzle for the category: ${categoryDescription}

CREATIVE DIRECTION: Think about ${randomSeed} related to this category. Be creative and unexpected with your theme choice!

STRICT REQUIREMENTS:
1. Pick ONE theme word that is EXACTLY ${wordLength} letters - must be UNIQUE and INTERESTING
2. Pick 5 related words that are ALL EXACTLY ${wordLength} letters each
3. ALL 6 words MUST be common English words found in Merriam-Webster or Oxford dictionaries
4. Use ONLY words that appear in standard word games like Scrabble or crossword puzzles
5. NO proper nouns, NO brand names, NO abbreviations, NO slang, NO informal words
6. NO hyphenated words, NO compound words, NO technical jargon, NO plurals ending in S if singular works
7. NO archaic, obsolete, rare, or regional dialect words
8. The theme should be CREATIVE and UNEXPECTED - avoid obvious/common themes
9. The 5 related words must clearly and logically connect to the theme
10. Create a helpful hint that describes the theme (without using the theme word)

VALIDATION CHECKLIST - For EACH word, verify:
‚úì It appears in major dictionaries (Merriam-Webster, Oxford)
‚úì A typical adult would recognize it immediately  
‚úì It would be accepted in Scrabble
‚úì It has EXACTLY ${wordLength} letters (count carefully!)
‚úì It contains only letters A-Z (no hyphens, spaces, apostrophes)

Count each word's letters carefully: ${wordLength} letters means ${wordLength} letters exactly.${avoidThemesInstruction}

Respond with ONLY valid JSON (no markdown, no explanation):
{"theme": "WORD1", "words": ["WORD2", "WORD3", "WORD4", "WORD5", "WORD6"], "hint": "Description of theme"}`;

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o',
          messages: [
            {
              role: 'system',
              content: `You are an expert word game designer for mainstream puzzle games. Your words MUST:
1. Be real English words found in Merriam-Webster and Oxford dictionaries
2. Be exactly ${wordLength} letters each - count very carefully!
3. Be commonly known by average adults
4. Be valid Scrabble words
5. Never be made-up, obscure, technical, or archaic
6. Be creative and varied - avoid repetitive or obvious theme choices

You will be penalized for:
- Words not in standard dictionaries
- Wrong letter counts
- Repeated/similar themes
- Obscure or unusual words

Return ONLY valid JSON with no additional text.`
            },
            {
              role: 'user',
              content: prompt
            }
          ],
          temperature: 0.9,
          max_tokens: 400
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error?.message || `API request failed: ${response.status}`);
      }

      const data = await response.json();
      const content = data.choices[0].message.content.trim();
      
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('Invalid response format from AI');
      }

      return JSON.parse(jsonMatch[0]);
    }

    function validateWords(result, expectedLength) {
      if (!result.theme || !result.words || !result.hint) {
        return { valid: false, reason: 'Missing required fields' };
      }

      if (!Array.isArray(result.words) || result.words.length !== 5) {
        return { valid: false, reason: 'Must have exactly 5 related words' };
      }

      const themeClean = result.theme.toUpperCase().replace(/[^A-Z]/g, '');
      if (themeClean.length !== expectedLength) {
        return { valid: false, reason: `Theme "${result.theme}" has ${themeClean.length} letters, expected ${expectedLength}` };
      }

      if (/[^A-Za-z]/.test(result.theme.trim())) {
        return { valid: false, reason: `Theme contains invalid characters` };
      }

      const allWords = [themeClean];
      for (const word of result.words) {
        const wordClean = word.toUpperCase().replace(/[^A-Z]/g, '');
        
        if (wordClean.length !== expectedLength) {
          return { valid: false, reason: `Word "${word}" has ${wordClean.length} letters, expected ${expectedLength}` };
        }

        if (/[^A-Za-z]/.test(word.trim())) {
          return { valid: false, reason: `Word "${word}" contains invalid characters` };
        }

        if (allWords.includes(wordClean)) {
          return { valid: false, reason: `Duplicate word "${word}" found` };
        }
        allWords.push(wordClean);
      }

      return { valid: true };
    }

    function displaySets() {
      setsGrid.innerHTML = '';
      document.getElementById('totalCount').textContent = generatedSets.length;

      generatedSets.forEach((set, index) => {
        const theme = set.theme.toUpperCase().replace(/[^A-Z]/g, '');
        const relatedWords = set.words.map(w => w.toUpperCase().replace(/[^A-Z]/g, ''));
        const allWords = shuffleArray([theme, ...relatedWords]);

        const card = document.createElement('div');
        card.className = 'set-card';
        card.dataset.index = index;

        card.innerHTML = `
          <div class="set-card-header">
            <input type="checkbox" class="set-checkbox" data-index="${index}">
            <span class="set-number">${index + 1}</span>
            <span class="set-theme">${theme}</span>
            <span class="set-category">${categoryEmojis[set.category]} ${set.category}</span>
          </div>
          <div class="set-card-body">
            <div class="set-words">
              ${allWords.map(word => `
                <span class="set-word ${word === theme ? 'theme' : ''}">${word}</span>
              `).join('')}
            </div>
            <div class="set-hint">üí° ${set.hint}</div>
          </div>
        `;

        setsGrid.appendChild(card);
      });

      // Add event listeners
      document.querySelectorAll('.set-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handleCheckboxChange);
      });

      updateSelectedCount();
    }

    function handleCheckboxChange(e) {
      const index = parseInt(e.target.dataset.index);
      generatedSets[index].selected = e.target.checked;
      
      const card = e.target.closest('.set-card');
      card.classList.toggle('selected', e.target.checked);
      
      updateSelectedCount();
    }

    function selectAll() {
      generatedSets.forEach((set, index) => {
        set.selected = true;
        const checkbox = document.querySelector(`.set-checkbox[data-index="${index}"]`);
        const card = checkbox.closest('.set-card');
        checkbox.checked = true;
        card.classList.add('selected');
      });
      updateSelectedCount();
    }

    function deselectAll() {
      generatedSets.forEach((set, index) => {
        set.selected = false;
        const checkbox = document.querySelector(`.set-checkbox[data-index="${index}"]`);
        const card = checkbox.closest('.set-card');
        checkbox.checked = false;
        card.classList.remove('selected');
      });
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const count = generatedSets.filter(s => s.selected).length;
      document.getElementById('selectedCount').textContent = count;
    }

    function generateOutput() {
      const selectedSets = generatedSets.filter(s => s.selected);
      
      if (selectedSets.length === 0) {
        showError('Please select at least one set');
        return;
      }

      // Assign sequential dates to selected sets starting from the chosen date
      const startDate = startDateInput.value;
      selectedSets.forEach((set, index) => {
        const setDate = new Date(startDate);
        setDate.setDate(setDate.getDate() + index);
        set.date = setDate.toISOString().split('T')[0];
      });

      const wordsLines = [];
      const themesLines = [];
      const hintsLines = [];

      selectedSets.forEach(set => {
        const theme = set.theme.toUpperCase().replace(/[^A-Z]/g, '');
        const relatedWords = set.words.map(w => w.toUpperCase().replace(/[^A-Z]/g, ''));
        const allWords = shuffleArray([theme, ...relatedWords]);
        const formattedDate = formatDate(set.date);

        wordsLines.push(`'${formattedDate}': ['${allWords.join("', '")}'],`);
        themesLines.push(`'${formattedDate}': ['Theme: ${theme}'],`);
        hintsLines.push(`'${formattedDate}': ['Hint: ${set.hint}'],`);
      });

      document.getElementById('wordsOutput').textContent = wordsLines.join('\n');
      document.getElementById('themesOutput').textContent = themesLines.join('\n');
      document.getElementById('hintsOutput').textContent = hintsLines.join('\n');

      document.getElementById('wordsCount').textContent = selectedSets.length;
      document.getElementById('themesCount').textContent = selectedSets.length;
      document.getElementById('hintsCount').textContent = selectedSets.length;

      outputSection.classList.add('visible');
      outputSection.scrollIntoView({ behavior: 'smooth' });
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const options = { day: 'numeric', month: 'long', year: 'numeric' };
      return date.toLocaleDateString('en-GB', options);
    }

    function setLoading(loading) {
      generateBtn.disabled = loading;
      generateBtn.classList.toggle('loading', loading);
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('visible');
    }

    function hideError() {
      errorMessage.classList.remove('visible');
    }

    // Copy button functionality
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const text = document.getElementById(targetId).textContent;

        navigator.clipboard.writeText(text).then(() => {
          this.textContent = 'Copied!';
          this.classList.add('copied');

          setTimeout(() => {
            this.textContent = 'Copy';
            this.classList.remove('copied');
          }, 2000);
        });
      });
    });
  </script>
</body>
</html>
