<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DownWords Game - Archive Play</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        
        #archive-date {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5em;
            color: #333;
        }
        
        #replay-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        #replay-button:hover {
            background-color: #0b7dda;
        }
        
        .button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        
        body.dark-mode .letter {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
        }
        
        body.dark-mode button {
            background-color: #444;
            color: #fff;
            border: 1px solid #666;
        }
        
        body.dark-mode #gameCompletionMessage {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
        }
        
        body.dark-mode .back-button {
            background-color: #388e3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="archive.html" class="back-button">‚Üê Back to Archive</a>
            <h1>DownWords Game</h1>
            <h2 id="archive-date">Archive Puzzle</h2>
        </div>

        <div id="timer">Time: 0</div>
        
        <div id="letter-grid"></div>
        
        <div id="selected-words-container"></div>
        
        <div id="hint-display"></div>
        <div id="theme-display"></div>
        
        <div id="success-message" style="display: none;">
            <h2>Congratulations!</h2>
            <textarea id="gameCompletionMessage" rows="10" cols="40" readonly></textarea>
            <div class="button-container">
                <button id="copyButton" style="display: none;">Copy</button>
                <button id="shareButton" style="display: none;">Share to Twitter</button>
            </div>
        </div>
        
        <div class="button-container">
            <button id="start-button">Start Game</button>
            <button id="hint-button" style="display: none;">Show Hint</button>
            <button id="theme-button" style="display: none;">Show Theme</button>
            <button id="mute-button" style="display: none;">üîá Mute</button>
            <button id="grid-reset-button" style="display: none;">Reset Grid</button>
            <button id="replay-button" style="display: none;">Play This Date Again</button>
            <button id="reset-button" style="display: none;">Start Over</button>
            <button id="mode-toggle" style="display: none;">‚òÄÔ∏è</button>
        </div>
    </div>

    <!-- Include your word lists data -->
    <script src="word-lists.js"></script>
    
    <!-- Include the game script with modifications for archive play -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if there's a date parameter in the URL
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');
            
            let selectedDate;
            if (dateParam) {
                try {
                    selectedDate = decodeURIComponent(dateParam);
                    // Verify this date exists in our word lists
                    if (!wordListsByDate[selectedDate]) {
                        selectedDate = localStorage.getItem('selectedPuzzleDate') || 'default';
                    }
                } catch (e) {
                    console.error('Error parsing date parameter:', e);
                    selectedDate = localStorage.getItem('selectedPuzzleDate') || 'default';
                }
            } else {
                selectedDate = localStorage.getItem('selectedPuzzleDate') || 'default';
            }
            
            document.getElementById('archive-date').textContent = `Archive Puzzle: ${selectedDate}`;
            
            // Show the replay button only for archive puzzles
            if (selectedDate && selectedDate !== 'default') {
                document.getElementById('replay-button').style.display = 'inline-block';
            }
            
            // Game elements
            const grid = document.getElementById('letter-grid');
            const wordsContainer = document.getElementById('selected-words-container');
            const timerDisplay = document.getElementById('timer');
            const successMessage = document.getElementById('success-message');
            const hintDisplay = document.getElementById('hint-display');
            const themeDisplay = document.getElementById('theme-display');

            // Add the audio elements
            const letterClickSound = new Audio('click-sound.mp3');
            const matchSound = new Audio('match-sound.mp3');
            const successSound = new Audio('finish-sound.mp3');
            const bonusSound = new Audio('bonus.mp3');

            // Dictionary for bonus words
            let dictionary = new Set(); // Using a Set for fast lookups
            let bonusWordsFound = new Set(); // Track found bonus words

            // Create a container for bonus words
            const bonusWordsContainer = document.createElement('div');
            bonusWordsContainer.id = 'bonus-words-container';
            bonusWordsContainer.style.marginTop = '20px';
            bonusWordsContainer.style.display = 'none';
            document.body.insertBefore(bonusWordsContainer, wordsContainer.nextSibling);

            // Add a heading for bonus words
            const bonusWordsHeading = document.createElement('h3');
            bonusWordsHeading.textContent = 'Bonus Words:';
            bonusWordsHeading.style.textAlign = 'center';
            bonusWordsHeading.style.marginBottom = '10px';
            bonusWordsContainer.appendChild(bonusWordsHeading);

            // Load the dictionary file
            fetch('dictionary.txt')
                .then(response => response.text())
                .then(text => {
                    // Split the text file by newlines and add each word to the Set
                    const words = text.split('\n').map(word => word.trim().toUpperCase());
                    dictionary = new Set(words);
                    console.log('Dictionary loaded with', dictionary.size, 'words');
                })
                .catch(error => console.error('Error loading dictionary:', error));

            // Get words for the selected date
            function getWordsForSelectedDate() {
                return wordListsByDate[selectedDate] || wordListsByDate['default'];
            }

            // Get theme for the selected date
            function getThemeForSelectedDate() {
                return ThemesByDate[selectedDate] || ThemesByDate['default'];
            }

            // Get hint for the selected date
            function getHintForSelectedDate() {
                return HintsByDate[selectedDate] || HintsByDate['default'];
            }

            // Format time function
            function formatTime(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes}m ${seconds < 10 ? '0' : ''}${seconds}s`;
            }

            // Get the words, hint, and theme for the selected date
            const words = getWordsForSelectedDate();
            const hintText = getHintForSelectedDate();
            const themeText = getThemeForSelectedDate();

            let selectedLetters = [];
            let matchedWords = [];
            let isMuted = false;
            const colours = ['#a0d2eb', '#ffc6a0', '#c8e6a0', '#f7a0eb', '#d0a0ff'];

            // Set the hint and theme as hidden by default
            hintDisplay.style.display = 'none';
            themeDisplay.style.display = 'none';

            // Determine the height of the grid (based on the longest word)
            const numRows = Math.max(...words.map(word => word.length)); 
            const numCols = words.length;

            // Function to update the bonus words display
            function updateBonusWordsDisplay() {
                // Clear existing content except the heading
                while (bonusWordsContainer.childNodes.length > 1) {
                    bonusWordsContainer.removeChild(bonusWordsContainer.lastChild);
                }
                
                // Show the container if we have bonus words
                if (bonusWordsFound.size > 0) {
                    bonusWordsContainer.style.display = 'block';
                    
                    // Create a flex container for the bonus words
                    const flexContainer = document.createElement('div');
                    flexContainer.style.display = 'flex';
                    flexContainer.style.flexWrap = 'wrap';
                    flexContainer.style.justifyContent = 'center';
                    flexContainer.style.gap = '10px';
                    
                    // Add each bonus word
                    [...bonusWordsFound].forEach(word => {
                        const wordDiv = document.createElement('div');
                        wordDiv.textContent = `‚≠ê ${word}`;
                        wordDiv.style.backgroundColor = '#f7d358';
                        wordDiv.style.padding = '0.5em';
                        wordDiv.style.borderRadius = '5px';
                        wordDiv.style.margin = '5px';
                        flexContainer.appendChild(wordDiv);
                    });
                    
                    bonusWordsContainer.appendChild(flexContainer);
                } else {
                    bonusWordsContainer.style.display = 'none';
                }
            }

            // Timer functionality
            let timer;
            let timeLeft = 0;

            function startTimer() {
                timer = setInterval(() => {
                    timeLeft++;
                    timerDisplay.textContent = `Time: ${timeLeft}`;
                }, 1000);  // Update the timer every second
            }

            function stopTimer() {
                clearInterval(timer);
            }

            // Function to unselect specific letters (for bonus words)
            function unselectLetters(lettersToUnselect) {
                lettersToUnselect.forEach(obj => {
                    obj.element.classList.remove('selected');
                    obj.element.style.backgroundColor = '';
                });
                
                // Remove these letters from the selectedLetters array
                selectedLetters = selectedLetters.filter(obj => !lettersToUnselect.includes(obj));
            }

            // Function to create and initialize the grid
            function createGrid() {
                // Clear the grid
                grid.innerHTML = '';
                
                // Create the grid based on the words list
                const gridArray = Array.from({ length: numRows }, () => Array(numCols).fill(null));

                words.forEach((word, colIndex) => {
                    [...word].forEach((letter, rowIndex) => {
                        gridArray[rowIndex][colIndex] = letter;
                    });
                });

                // Shuffle each row randomly
                gridArray.forEach(row => {
                    row.sort(() => Math.random() - 0.5);  // Shuffle letters within the row
                });

                // Create the grid elements
                grid.style.gridTemplateColumns = `repeat(${numCols}, 60px)`;
                grid.style.gridTemplateRows = `repeat(${numRows}, 60px)`;

                gridArray.forEach((row, rowIndex) => {
                    row.forEach((letter, colIndex) => {
                        const div = document.createElement('div');
                        div.classList.add('letter');
                        div.textContent = letter || '';  // Fill empty cells with nothing
                        div.dataset.row = rowIndex;
                        div.dataset.col = colIndex;

                        div.addEventListener('click', () => {
                            // Play click sound
                            if (!isMuted){
                                letterClickSound.play();
                            }
                            const isSelected = div.classList.contains('selected');

                            if (isSelected) {
                                // Remove from selectedLetters and unselect the letter
                                selectedLetters = selectedLetters.filter(obj => obj.element !== div);
                                div.classList.remove('selected');
                                div.style.backgroundColor = '';
                            } else {
                                // Count how many letters are already selected in this row
                                const selectedInRow = selectedLetters.filter(obj => obj.rowIndex === rowIndex).length;
                                const allowedPerRow = matchedWords.length + 1;

                                if (selectedInRow >= allowedPerRow) {
                                    // Optionally give user feedback
                                    div.classList.add('shake');
                                    setTimeout(() => div.classList.remove('shake'), 300);
                                    return;
                                }

                                // Add to selectedLetters
                                selectedLetters.push({ letter, element: div, rowIndex, colIndex });
                                div.classList.add('selected');
                            }

                            updateWordGroups();
                        });

                        grid.appendChild(div);
                    });
                });
            }

            // Create the initial grid
            createGrid();

            // Hide the grid before the start button is pressed
            grid.style.display = 'none';

            // Hide the buttons before the start button is pressed
            document.getElementById('hint-button').style.display = 'none'; 
            document.getElementById('theme-button').style.display = 'none';
            document.getElementById('mute-button').style.display = 'none';
            document.getElementById('grid-reset-button').style.display = 'none';
            document.getElementById('reset-button').style.display = 'none';
            document.getElementById('mode-toggle').style.display = 'none';

            // Update word groups and check for matches
            function updateWordGroups() {
                // Clear all previous colours
                selectedLetters.forEach(obj => obj.element.style.backgroundColor = '');

                // Group by click order (the first N letters for each word form a group)
                const groups = [];
                let currentIndex = 0;

                words.forEach(word => {
                    const group = selectedLetters.slice(currentIndex, currentIndex + word.length);
                    groups.push(group);
                    currentIndex += word.length;
                });

                // Sort each group by rowIndex to display letters in vertical order within the group
                groups.forEach(group => {
                    group.sort((a, b) => a.rowIndex - b.rowIndex);
                });

                // Apply colours and display words
                wordsContainer.innerHTML = '';  // Clear previous words
                const wordGroups = [];
                
                groups.forEach((group, i) => {
                    const word = group.map(obj => obj.letter).join('');
                    const wordDiv = document.createElement('div');
                    wordDiv.textContent = word;
                    wordDiv.style.padding = '0.5em';
                    wordDiv.style.margin = '0.2em auto';
                    wordDiv.style.width = 'fit-content';
                    wordDiv.style.borderRadius = '5px';

                    // Check if the selected letters match the word
                    if (words.includes(word)) {
                        wordDiv.style.backgroundColor = '#76e77d';  // Green for a match
                        wordDiv.textContent = `‚úîÔ∏è ${word}`;  // Add a checkmark to indicate a valid word

                        // Make the matched letters invisible but preserve the grid layout
                        group.forEach(obj => {
                            obj.element.style.opacity = '0.3';  // Hide the letter but keep the space
                            obj.element.style.pointerEvents = 'none';  // Disable any interaction (clicking)
                        });

                        // Add the word to matchedWords and check if all words are matched
                        if (!matchedWords.includes(word)) {
                            matchedWords.push(word);
                            // Play match sound
                            if (!isMuted){
                                matchSound.play();
                            }
                        }
                        
                        if (matchedWords.length === words.length) {
                            stopTimer();
                            if (!isMuted){
                                successSound.play(); // Play success sound
                            }

                            const playerTimeInSeconds = timeLeft; 
                            const averageTimeInSeconds = 151;     
                            const blocklength = averageTimeInSeconds/8;
                        
                            // Build the share message
                            let message = '';
                            
                            // Add archive date information if playing from archive
                            if (selectedDate && selectedDate !== 'default') {
                                message += `I completed the DownWords archive puzzle from ${selectedDate} in ${formatTime(timeLeft)}\n`;
                            } else {
                                message += `I completed today's DownWords in ${formatTime(timeLeft)} compared to the average of ${formatTime(averageTimeInSeconds)}\n`;
                            }

                            // Convert times to blocks (each block represents one 8th of the average time)
                            const playerBlocks = Math.floor(playerTimeInSeconds / blocklength);
                            const averageBlocks = Math.floor(averageTimeInSeconds / blocklength);

                            // Build the block strings
                            let playerBlocksString = '';
                            let averageBlocksString = '';

                            // If player is slower than average
                            if (playerTimeInSeconds > averageTimeInSeconds) {
                                const extraTime = Math.min(playerTimeInSeconds - averageTimeInSeconds, blocklength * 3);
                                const extraBlocks = Math.ceil(extraTime / blocklength);
                                playerBlocksString = 'üü©'.repeat(averageBlocks) + 'üü•'.repeat(extraBlocks);
                            } else {
                                const minimumPlayerBlocks = Math.max(1, playerBlocks); // Make sure at least 1 block
                                playerBlocksString = 'üü©'.repeat(minimumPlayerBlocks);
                            }

                            // Average is always green blocks (no red needed)
                            averageBlocksString = 'üü©'.repeat(averageBlocks);

                            // Format the final message
                            message += `\n${playerBlocksString} - Me (${formatTime(timeLeft)})`;
                            
                            // Only include average comparison for current day puzzles
                            if (!selectedDate || selectedDate === 'default') {
                                message += `\n${averageBlocksString} - Average (${formatTime(averageTimeInSeconds)}) \n`;
                            }

                            // Add bonus words found to the message
                            if (bonusWordsFound.size > 0) {
                                const duckEmojis = 'ü¶Ü'.repeat(bonusWordsFound.size);
                                message += `\n${duckEmojis} - Found ${bonusWordsFound.size} bonus word${bonusWordsFound.size > 1 ? 's' : ''} \n`;
                            }
                            
                            // Both hint and theme are hidden, do something here
                            if (getComputedStyle(hintDisplay).display === 'none' && getComputedStyle(themeDisplay).display === 'none') {
                                message += `\nüèÜ - No hints`;
                            }
                            
                            // Check player speed - only for current day puzzles
                            if (!selectedDate || selectedDate === 'default') {
                                if (timeLeft < averageTimeInSeconds * 0.2) {
                                    message += `\nüëë - Top 20% of players today!`;
                                } else if (timeLeft < averageTimeInSeconds) {
                                    message += `\nüèÖ - Top 50% of players today`;
                                }
                            }
                            
                            message += `\n`;
                            message += `\nhttp://www.DownWordsGame.com`;
                            
                            // Add archive link if playing from archive
                            if (selectedDate && selectedDate !== 'default') {
                                // Create a URL-friendly date format
                                const urlFriendlyDate = selectedDate.replace(/\s+/g, '-').toLowerCase();
                                message += `/archive?date=${encodeURIComponent(selectedDate)}`;
                            }
                            
                            message += `\n#DownWordsGame`;
                            
                            // Show the text box with the completion message
                            showCompletionMessage();

                            // Populate the text box with the completion message
                            document.getElementById('gameCompletionMessage').value = message;

                            // Show the copy and share buttons
                            document.getElementById('shareButton').style.display = 'block';
                            document.getElementById('copyButton').style.display = 'block';
                            
                            // Remove the grid once all words are matched
                            grid.style.display = 'none';  // Hide the grid
                            hintDisplay.style.display = 'none'; // Hide the Hint text
                            themeDisplay.style.display = 'none'; // Hide the theme text
                            document.getElementById('hint-button').style.display = 'none'; // Hide all the buttons
                            document.getElementById('theme-button').style.display = 'none';
                            document.getElementById('mute-button').style.display = 'none';
                            document.getElementById('grid-reset-button').style.display = 'none';
                            document.getElementById('replay-button').style.display = 'none';
                            bonusWordsContainer.style.display = 'none'; // Hide bonus words container

                            if (typeof gtag === 'function') {
                                gtag('event', 'game_completed', {
                                    'event_category': 'gameplay',
                                    'event_label': selectedDate !== 'default' ? `Archive: ${selectedDate}` : 'Today\'s Puzzle',
                                    'value': timeLeft
                                });
                            }
                        }
                    } else {
                        // Check if it's a bonus word (in dictionary but not in target words)
                        if (group.length === words[0].length && // Only check if the group has the right number of letters
                            !words.includes(word) && 
                            dictionary.has(word) && 
                            word.length >= 3 && // Only consider words of at least 3 letters
                            !bonusWordsFound.has(word)) { // Only show alert for new bonus words

                            // Play a sound
                            if (!isMuted){
                                bonusSound.play();
                            }
                            
                            // Add to found bonus words
                            bonusWordsFound.add(word);
                            
                            // Update the bonus words display
                            updateBonusWordsDisplay();
                            
                            // Store the current group to unselect later
                            const bonusWordLetters = [...group]; // Create a copy of the group
                            
                            // Show congratulation alert
                            setTimeout(() => {
                                alert(`Bonus word found: ${word}! Great job finding an extra word!`);
                                
                                // Unselect only the letters that formed the bonus word
                                unselectLetters(bonusWordLetters);
                                
                                // Track the bonus word event
                                if (typeof gtag === 'function') {
                                    gtag('event', 'bonus_word_found', {
                                        'event_category': 'gameplay',
                                        'event_label': word
                                    });
                                }
                                
                                // Update the display to remove the bonus word from the main display
                                updateWordGroups();
                            }, 300); // Small delay so the UI updates first
                            
                            return; // Exit early to prevent adding this word to wordGroups
                        } else {
                            wordDiv.style.backgroundColor = colours[i % colours.length];
                        }
                    }

                    wordGroups.push(wordDiv);
                    
                    // Apply the same colour to grid letters
                    group.forEach(obj => {
                        obj.element.style.backgroundColor = wordDiv.style.backgroundColor;
                    });
                });

                // Arrange the words into two columns by splitting the array into two part
                const halfIndex = Math.ceil(wordGroups.length / 2);
                const firstColumn = wordGroups.slice(0, halfIndex);
                const secondColumn = wordGroups.slice(halfIndex);

                // Clear the container and add the columns
                wordsContainer.innerHTML = '';

                // Append the two columns
                firstColumn.forEach(wordDiv => wordsContainer.appendChild(wordDiv));
                secondColumn.forEach(wordDiv => wordsContainer.appendChild(wordDiv));
            }

            // Function to show completion message
            function showCompletionMessage() {
                const message = document.getElementById('gameCompletionMessage');
                message.style.display = 'block'; // Make it block first
                successMessage.style.display = 'block';
                setTimeout(() => {
                    message.classList.add('active'); // Then animate
                }, 10); // Tiny delay so the browser can register the transition
            }

            // Start Button functionality
            document.getElementById('start-button').addEventListener('click', () => {
                grid.style.display = 'grid';
                document.getElementById('start-button').style.display = 'none';

                // Show other buttons
                document.getElementById('hint-button').style.display = 'block'; 
                document.getElementById('theme-button').style.display = 'block';
                document.getElementById('mute-button').style.display = 'block';
                document.getElementById('grid-reset-button').style.display = 'block';
                document.getElementById('reset-button').style.display = 'block';
                document.getElementById('mode-toggle').style.display = 'block';
                if (selectedDate && selectedDate !== 'default') {
                    document.getElementById('replay-button').style.display = 'block';
                }

                startTimer();
            });

            // Hint Button functionality
            document.getElementById('hint-button').addEventListener('click', () => {
                hintDisplay.textContent = hintText;
                hintDisplay.style.display = 'block'; // Reveal the hint

                if (typeof gtag === 'function') {
                    gtag('event', 'reveal_hint', {
                        event_category: 'help',
                        event_label: 'Reveal Hint Button',
                        value: 1
                    });
                }
            });

            // Theme Button functionality
            document.getElementById('theme-button').addEventListener('click', () => {
                themeDisplay.textContent = themeText;
                themeDisplay.style.display = 'block'; // Reveal the theme

                if (typeof gtag === 'function') {
                    gtag('event', 'reveal_theme', {
                        event_category: 'help',
                        event_label: 'Reveal Theme Button',
                        value: 1
                    });
                }
            });

            // Mute button functionality
            document.getElementById('mute-button').addEventListener('click', () => {
                isMuted = !isMuted;
                document.getElementById('mute-button').textContent = isMuted ? 'üîä Unmute' : 'üîá Mute';

                if (typeof gtag === 'function') {
                    gtag('event', 'mute_toggle', {
                        event_category: 'settings',
                        event_label: 'Mute Button',
                        value: 1
                    });
                }
            });

            // Reset Button for StartOver
            document.getElementById('reset-button').addEventListener('click', () => {
                location.reload(); // Reloads the page, effectively resetting everything

                if (typeof gtag === 'function') {
                    gtag('event', 'start_over', {
                        event_category: 'game_control',
                        event_label: 'Start Over Button',
                        value: 1
                    });
                }
            });

            // Grid Reset Button 
            document.getElementById('grid-reset-button').addEventListener('click', () => {
                selectedLetters = [];
                matchedWords = [];
                bonusWordsFound.clear();
                updateBonusWordsDisplay();

                if (typeof gtag === 'function') {
                    gtag('event', 'grid_reset', {
                        event_category: 'game_control',
                        event_label: 'Grid Reset Button',
                        value: 1
                    });
                }
                
                wordsContainer.innerHTML = '';
                createGrid();
            });

            // Replay Button (for archive puzzles)
            document.getElementById('replay-button').addEventListener('click', () => {
                // Reset the game state but keep the same date
                selectedLetters = [];
                matchedWords = [];
                bonusWordsFound.clear();
                updateBonusWordsDisplay();
                
                // Reset the UI
                wordsContainer.innerHTML = '';
                
                // Recreate the grid
                createGrid();
                
                // Reset the timer
                stopTimer();
                timeLeft = 0;
                timerDisplay.textContent = `Time: ${timeLeft}`;
                startTimer();
                
                // Hide success message if visible
                successMessage.style.display = 'none';
                
                if (typeof gtag === 'function') {
                    gtag('event', 'replay_archive', {
                        event_category: 'game_control',
                        event_label: `Archive: ${selectedDate}`,
                        value: 1
                    });
                }
            });

            // Share button functionality
            document.getElementById('shareButton').addEventListener('click', () => {
                const message = document.getElementById('gameCompletionMessage').value;
                
                // Twitter URL
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
                window.open(twitterUrl, '_blank');

                if (typeof gtag === 'function') {
                    gtag('event', 'share_to_twitter', {
                        event_category: 'social',
                        event_label: selectedDate !== 'default' ? `Archive: ${selectedDate}` : 'Today\'s Puzzle',
                        value: 1
                    });
                }
            });

            // Add copy button functionality
            document.getElementById('copyButton').addEventListener('click', () => {
                document.getElementById('gameCompletionMessage').select();
                document.execCommand('copy');
                alert('Copied to clipboard!');

                if (typeof gtag === 'function') {
                    gtag('event', 'copy_result', {
                        event_category: 'engagement',
                        event_label: selectedDate !== 'default' ? `Archive: ${selectedDate}` : 'Today\'s Puzzle',
                        value: 1
                    });
                }
            });

            // Dark Mode Toggle Functionality
            const modeToggle = document.getElementById('mode-toggle');
            let isDarkMode = false;

            // Initialize in light mode by default
            modeToggle.textContent = '‚òÄÔ∏è';
            
            // Check for saved user preference
            if (localStorage.getItem('darkMode') === 'true') {
                enableDarkMode();
            }

            modeToggle.addEventListener('click', () => {
                if (isDarkMode) {
                    disableDarkMode();
                } else {
                    enableDarkMode();
                }
            });

            function enableDarkMode() {
                document.body.classList.add('dark-mode');
                modeToggle.textContent = 'üåô';
                isDarkMode = true;
                localStorage.setItem('darkMode', 'true');
                
                if (typeof gtag === 'function') {
                    gtag('event', 'dark_mode_enabled', {
                        event_category: 'settings',
                        event_label: 'Dark Mode Toggle',
                        value: 1
                    });
                }
            }

            function disableDarkMode() {
                document.body.classList.remove('dark-mode');
                modeToggle.textContent = '‚òÄÔ∏è';
                isDarkMode = false;
                localStorage.setItem('darkMode', 'false');
                
                if (typeof gtag === 'function') {
                    gtag('event', 'light_mode_enabled', {
                        event_category: 'settings',
                        event_label: 'Light Mode Toggle',
                        value: 1
                    });
                }
            }
        });
    </script>
</body>
</html>
